<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <title>新聞管理後台 - 強發金屬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-5">
    <div class="container mt-5 shadow-sm p-4 bg-white rounded">
        <h2 class="mb-4">新聞管理後台</h2>

        <h5 class="mb-3" id="form-title">新增最新消息</h5>
        <form id="newsForm" class="mb-4">
            <div class="mb-3">
                <label class="form-label">新聞標題</label>
                <input type="text" id="title" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">內容</label>
                <textarea id="content" class="form-control" rows="5" required></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">日期</label>
                <input type="text" id="date" class="form-control" value="" placeholder="例如：2026/2/27" required>
            </div>
            <div class="mb-3">
                <label class="form-label">圖片上傳（僅新增時可選填，編輯時不變更圖片）</label>
                <input type="file" id="image" class="form-control" accept="image/*">
            </div>
            <button type="submit" class="btn btn-primary me-2">儲存</button>
            <button type="button" id="cancelEditBtn" class="btn btn-secondary btn-sm d-none">取消編輯</button>
        </form>

        <h5 class="mb-3">已發布新聞</h5>
        <div class="table-responsive">
            <table class="table table-striped align-middle" id="newsTable">
                <thead>
                    <tr>
                        <th style="width: 60px;">序號</th>
                        <th>日期</th>
                        <th>標題</th>
                        <th style="width: 140px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" class="text-center text-muted">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const form = document.getElementById('newsForm');
        const formTitle = document.getElementById('form-title');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const titleInput = document.getElementById('title');
        const contentInput = document.getElementById('content');
        const dateInput = document.getElementById('date');
        const imageInput = document.getElementById('image');
        const tableBody = document.querySelector('#newsTable tbody');

        let editingIndex = null;
        let newsCache = [];

        function resetForm() {
            form.reset();
            const today = new Date();
            dateInput.value = today.toLocaleDateString('zh-TW');
            imageInput.value = '';
            editingIndex = null;
            formTitle.textContent = '新增最新消息';
            cancelEditBtn.classList.add('d-none');
        }

        async function loadNews() {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">載入中...</td></tr>';
            try {
                const res = await fetch('/admin-api/news');
                if (!res.ok) throw new Error('load failed');
                const data = await res.json();
                newsCache = Array.isArray(data) ? data : [];

                if (newsCache.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">目前尚無新聞</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';
                newsCache.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.date || ''}</td>
                        <td>${item.title || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-2" data-action="edit" data-index="${index}">編輯</button>
                            <button class="btn btn-sm btn-outline-danger" data-action="delete" data-index="${index}">刪除</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (e) {
                console.error(e);
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">載入失敗，請稍後再試</td></tr>';
            }
        }

        tableBody.addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.getAttribute('data-action');
            const index = parseInt(btn.getAttribute('data-index'), 10);
            if (!Number.isFinite(index)) return;

            if (action === 'edit') {
                const item = newsCache[index];
                if (!item) return;
                editingIndex = index;
                titleInput.value = item.title || '';
                contentInput.value = item.content || '';
                dateInput.value = item.date || '';
                imageInput.value = '';
                formTitle.textContent = '編輯新聞（不變更圖片）';
                cancelEditBtn.classList.remove('d-none');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            if (action === 'delete') {
                const ok = confirm('確定要刪除此則新聞嗎？此動作會一併刪除對應圖片檔。');
                if (!ok) return;
                try {
                    const res = await fetch(`/admin-api/news/${index}`, { method: 'DELETE' });
                    if (!res.ok && res.status !== 204) throw new Error('delete failed');
                    await loadNews();
                    resetForm();
                } catch (err) {
                    console.error(err);
                    alert('刪除失敗，請稍後再試');
                }
            }
        });

        cancelEditBtn.addEventListener('click', () => {
            resetForm();
        });

        form.onsubmit = async (e) => {
            e.preventDefault();

            try {
                if (editingIndex === null) {
                    // 新增：支援圖片上傳
                    const formData = new FormData();
                    formData.append('title', titleInput.value);
                    formData.append('content', contentInput.value);
                    formData.append('date', dateInput.value);

                    if (imageInput.files && imageInput.files[0]) {
                        formData.append('image', imageInput.files[0]);
                    }

                    const res = await fetch('/admin-api/news', {
                        method: 'POST',
                        body: formData
                    });

                    if (!res.ok) throw new Error('create failed');
                } else {
                    // 編輯：僅更新文字與日期，不變更圖片
                    const payload = {
                        title: titleInput.value,
                        content: contentInput.value,
                        date: dateInput.value
                    };
                    const res = await fetch(`/admin-api/news/${editingIndex}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error('update failed');
                }

                await loadNews();
                resetForm();
                alert('儲存成功！');
            } catch (err) {
                console.error(err);
                alert('儲存失敗，請稍後再試');
            }
        };

        // 初始
        const today = new Date();
        dateInput.value = today.toLocaleDateString('zh-TW');
        loadNews();
    </script>
</body>
</html>
